# HyperFleet Pull Secret Adapter Configuration
#
# This AdapterConfig defines the configuration for the Pull Secret Adapter,
# which manages image pull secrets in GCP Secret Manager for HyperShift clusters.
#
# Version: 1.0.0

apiVersion: hyperfleet.redhat.com/v1alpha1
kind: AdapterConfig
metadata:
  name: pullsecret-adapter
  namespace: hyperfleet-system
  labels:
    hyperfleet.io/adapter-type: pullsecret
    hyperfleet.io/component: adapter
    hyperfleet.io/cloud-provider: gcp
    hyperfleet.io/version: v1.0.0

# ============================================================================
# Adapter Specification
# ============================================================================
spec:
  # Adapter Information
  adapter:
    # Adapter version
    version: "1.0.0"
  
  # ============================================================================
  # Rule Engine Configuration (using expr-lang/expr)
  # ============================================================================
  # https://github.com/expr-lang/expr
  # Used by Google, Uber, Alibaba, OpenTelemetry, Argo for dynamic configuration
  ruleEngine:
    # Expression language type
    type: "expr"
    
    # Compile expressions at startup for better performance and early error detection
    compileOnStartup: true
    
    # Enable strict type checking (recommended)
    strictTypes: true
  # ============================================================================
  # HyperFleet API Configuration
  # ============================================================================
  hyperfleetApi:
    # HTTP client timeout for API calls
    timeout: 10s

  
    ############################################################################
    # Retry Configuration (post-MVP)
    ############################################################################
    # Number of retry attempts for failed API calls
    retryAttempts: 3
    
    # Retry backoff strategy: exponential, linear, constant
    retryBackoff: exponential

  # ============================================================================
  # Message Broker Configuration
  # ============================================================================
  messageBroker:
    # Process up to 50 events concurrently
    maxConcurrency: 50

  # ============================================================================
  # Kubernetes Configuration
  # ============================================================================
  kubernetes:
    # Use in-cluster Kubernetes configuration
    inCluster: true
    apiVersion: "v1"

    # Namespace for created resources (Jobs, Secrets)
    namespace: "hyperfleet-system"

  # ============================================================================
  # Event Handlers Configuration
  # ============================================================================
  
  # Optional: Filter incoming events before processing
  # If expression evaluates to false, event is skipped
  eventFilter:
    # Expr expression that returns boolean
    # Available variables: event (CloudEvent), cluster (from event.Data)
    expression: |
      event.Type in ["cluster.create", "cluster.update"] &&
      event.Data.resourceType == "cluster"
      event.Data.spec.provider == "gcp"    
    # Optional: Custom description for logging
    description: "Only process GCP cluster creation/update events"

  # Parameters to extract from CloudEvent and share across templates
  # These are available as template variables in all resources
  parameters:
    # Environment variables from deployment (used in templates)
    - name: "hyperfleetApiBaseUrl"
      source: "env.HYPERFLEET_API_BASE_URL"
      required: true
    - name: "hyperfleetApiVersion"
      source: "env.HYPERFLEET_API_VERSION"
      required: true
    - name: "hyperfleetApiToken"
      source: "env.HYPERFLEET_API_TOKEN"
      required: true
    # (MVP-post) further parameters can be added here
    
    # Extract from CloudEvent data
    - name: "resourceId"
      source: "event.resourceId"
      required: true
    - name: "resourceType"
      source: "event.resourceType"
      required: true
    - name: "eventGenerationId"
      source: "event.GenerationId"
      required: true

  # Preconditions: API calls and expressions to determine when to create Kubernetes resources
  # Use to fetch cluster details, validate, and check conditions before resource creation
  # Multiple preconditions can be defined and they will be evaluated in order
  # The adapter will only create resources if all preconditions are met
  preconditions:
    # GET cluster details from HyperFleet API
    - type: "api_call"
      method: "GET"
      endpoint: "{{ .hyperfleetApiBaseUrl }}/api/{{ .hyperfleetApiVersion }}/clusters/{{ .clusterId }}"

      # Store response in a parameter for use in templates and conditions
      storeResponseAs: "clusterDetails"

      # Extract specific fields for easier access in conditions
      extract:
        - as: "cloudProvider"
          field: "spec.provider"

        - as: "gcpProjectId"
          field: "spec.gcp.projectId"

        - as: "pullSecretData"
          field: "spec.pullSecret.data"

        - as: "pullSecretName"
          field: "spec.pullSecret.secretName"

        - as: "replicationPolicy"
          field: "spec.pullSecret.replicationPolicy"

        - as: "clusterName"
          field: "name"

        - as: "clusterPhase"
          field: "status.phase"

        - as: "validationStatus"
          field: "status.adapters[?(@.name=='validation')].conditions.Available.status"

        - as: "dnsStatus"
          field: "status.adapters[?(@.name=='dns')].conditions.Available.status"

        - as: "placementStatus"
          field: "status.adapters[?(@.name=='placement')].conditions.Available.status"

      # Evaluate preconditions - only proceed if all are met
      when:
        expression: |
          cloudProvider == "gcp" &&
          gcpProjectId != nil &&
          pullSecretData != nil &&
          validationStatus == "True" &&
          dnsStatus == "True" &&
          placementStatus == "True" &&
          clusterPhase in ["Provisioning", "Provisioned", "Ready"]

        description: "Create pull secret only when cluster is GCP, has required data, and dependencies (validation, DNS, placement) are complete"

  # ============================================================================
  # Kubernetes Resources
  # ============================================================================
  # Resources to create when preconditions are met
  resources:
    # -------------------------------------------------------------------------
    # Secret: Pull Secret Data
    # -------------------------------------------------------------------------
    # Store pull secret data as Kubernetes Secret for Job to consume
    - apiVersion: "v1"
      kind: "Secret"
      metadata:
        name: "cluster-{{ .clusterId }}-pullsecret-data"
        labels:
          hyperfleet.io/cluster-id: "{{ .clusterId }}"
          hyperfleet.io/cluster-name: "{{ .clusterName }}"
          hyperfleet.io/region: "{{ .region }}"
          hyperfleet.io/provider: "{{ .cloudProvider }}"
          hyperfleet.io/managed-by: "{{ .metadata.name }}"
          hyperfleet.io/adapter: "pullsecret"
          hyperfleet.io/resource-type: "secret"
        annotations:
          hyperfleet.io/event-id: "{{ .event.id }}"
          hyperfleet.io/generation: "{{ .generationId }}"
          hyperfleet.io/created-by: "pullsecret-adapter"
          hyperfleet.io/created-at: "{{ now }}"
      type: Opaque
      stringData:
        pullsecret: "{{ .clusterDetails.spec.pullSecret.data }}"

      # Track settings for coming events to check resource status
      track:
        as: "pullSecretDataSecret" # alias of the resource for the post-processing
        # just define k8s resources' discovery rules to discover the resource
        discovery: # discovery rules to discover the resource if name is not known or fixed
          bySelectors:
            labelSelector:
              hyperfleet.io/cluster-id: "{{ .clusterId }}"
              hyperfleet.io/resource-type: "secret"
              hyperfleet.io/managed-by: "{{ .metadata.name }}"

    # -------------------------------------------------------------------------
    # Job: Create Secret in GCP Secret Manager
    # -------------------------------------------------------------------------
    # Job that creates/updates secret in GCP Secret Manager
    - apiVersion: "batch/v1"
      kind: "Job"
      metadata:
        name: "pullsecret-{{ .clusterId }}-gen{{ .generationId }}"
        namespace: "hyperfleet-system"
        labels:
          hyperfleet.io/adapter: "pullsecret"
          hyperfleet.io/cluster-id: "{{ .clusterId }}"
          hyperfleet.io/cluster-name: "{{ .clusterName }}"
          hyperfleet.io/resource-type: "job"
          hyperfleet.io/region: "{{ .region }}"
          hyperfleet.io/provider: "{{ .cloudProvider }}"
          hyperfleet.io/managed-by: "{{ .metadata.name }}"
        annotations:
          hyperfleet.io/event-id: "{{ .event.id }}"
          hyperfleet.io/generation: "{{ .generationId }}"
          hyperfleet.io/gcp-project: "{{ .gcpProjectId }}"
          hyperfleet.io/secret-name: "{{ .pullSecretName }}"
          hyperfleet.io/created-by: "pullsecret-adapter"
          hyperfleet.io/created-at: "{{ now }}"          
      spec:
        # Retry up to 3 times on failure
        backoffLimit: 3

        # Clean up Job 1 hour after completion
        ttlSecondsAfterFinished: 3600

        template:
          metadata:
            labels:
              hyperfleet.io/adapter: "pullsecret"
              hyperfleet.io/cluster-id: "{{ .clusterId }}"
              hyperfleet.io/cluster-name: "{{ .clusterName }}"
          spec:
            restartPolicy: Never

            # Service account with Workload Identity for GCP access
            serviceAccountName: pullsecret-adapter-job

            containers:
            - name: secret-manager-job
              # Job container image
              image: quay.io/hyperfleet/pullsecret-job:v1.0.0
              imagePullPolicy: IfNotPresent

              # Environment variables for Job
              env:
              # Cluster information
              - name: CLUSTER_ID
                value: "{{ .clusterId }}"

              - name: CLUSTER_NAME
                value: "{{ .clusterName }}"

              # GCP configuration
              - name: GCP_PROJECT_ID
                value: "{{ .gcpProjectId }}"

              - name: SECRET_NAME
                value: "{{ .pullSecretName | default (printf \"hyperfleet-%s-pull-secret\" .clusterId) }}"

              - name: REPLICATION_POLICY
                value: "{{ .replicationPolicy | default \"automatic\" }}"

              # Secret labels for GCP Secret Manager
              - name: SECRET_LABELS
                value: "managed-by=hyperfleet,adapter=pullsecret,cluster-id={{ .clusterId }},cluster-name={{ .clusterName }},resource-type=pull-secret,hyperfleet-version=v1"

              # Pull secret data (from Kubernetes Secret)
              - name: PULL_SECRET_DATA
                valueFrom:
                  secretKeyRef:
                    name: cluster-{{ .clusterId }}-pullsecret-data
                    key: pullsecret

              # HyperFleet API configuration (for status reporting)
              - name: HYPERFLEET_API_URL
                value: "{{ .hyperfleetApiBaseUrl }}"

              - name: HYPERFLEET_API_TOKEN
                valueFrom:
                  secretKeyRef:
                    name: hyperfleet-api-token
                    key: token

              # Logging configuration
              - name: LOG_LEVEL
                value: "info"

              - name: LOG_FORMAT
                value: "json"

              # Timeout for GCP API calls
              - name: GCP_API_TIMEOUT
                value: "30s"

              # Resource limits
              resources:
                requests:
                  cpu: 100m
                  memory: 128Mi
                limits:
                  cpu: 500m
                  memory: 512Mi

              # Security context
              securityContext:
                allowPrivilegeEscalation: false
                runAsNonRoot: true
                runAsUser: 1000
                capabilities:
                  drop:
                  - ALL
                readOnlyRootFilesystem: true

      # Track this Job for status monitoring
      track:
        as: "pullSecretJob"
        discovery:
          bySelectors:
            labelSelector:
              hyperfleet.io/cluster-id: "{{ .clusterId }}"
              hyperfleet.io/adapter: "pullsecret"
              hyperfleet.io/resource-type: "job"

  # ============================================================================
  # Post-Processing
  # ============================================================================
  # Check Job status and report to HyperFleet API
  post:
    # -------------------------------------------------------------------------
    # Stage 1: Build Status Payload
    # -------------------------------------------------------------------------
    parameters:
      - name: "pullSecretStatus"
        build:
          # Standard conditions to report
          conditions:
            # ----------------------------------------------------------------
            # Applied Condition
            # ----------------------------------------------------------------
            # Resources have been applied to Kubernetes
            applied:
              status:
                expression: |
                  resources.pullSecretJob.status.conditions[?(@.type=='Complete')].status == "True" ||
                  resources.pullSecretJob.status.conditions[?(@.type=='Failed')].status == "True"

              reason:
                expression: |
                  resources.pullSecretJob.status.conditions[?(@.type=='Complete')].status == "True"
                  ? "SecretCreated"
                  : (resources.pullSecretJob.status.conditions[?(@.type=='Failed')].status == "True"
                     ? "JobFailed"
                     : "JobInProgress")

              message:
                expression: |
                  resources.pullSecretJob.status.conditions[?(@.type=='Complete')].status == "True"
                  ? "Pull secret successfully created in GCP Secret Manager"
                  : (resources.pullSecretJob.status.conditions[?(@.type=='Failed')].status == "True"
                     ? "Job failed to create pull secret - check pod logs for details"
                     : "Pull secret job is in progress")

            # ----------------------------------------------------------------
            # Available Condition
            # ----------------------------------------------------------------
            # Secret is available and ready for use
            available:
              status:
                expression: |
                  resources.pullSecretJob.status.conditions[?(@.type=='Complete')].status == "True" &&
                  resources.pullSecretJob.status.succeeded > 0

              reason:
                expression: |
                  resources.pullSecretJob.status.conditions[?(@.type=='Complete')].status == "True" &&
                  resources.pullSecretJob.status.succeeded > 0
                  ? "SecretAvailable"
                  : "SecretNotReady"

              message:
                expression: |
                  resources.pullSecretJob.status.conditions[?(@.type=='Complete')].status == "True" &&
                  resources.pullSecretJob.status.succeeded > 0
                  ? "Pull secret is available in GCP Secret Manager and ready for use"
                  : "Pull secret is not yet available or job failed"

            # ----------------------------------------------------------------
            # Health Condition
            # ----------------------------------------------------------------
            # Adapter is healthy and functioning
            health:
              status:
                expression: |
                  resources.pullSecretJob.status.conditions[?(@.type=='Failed')].status != "True" &&
                  (resources.pullSecretJob.status.failed ?? 0) < 1

              reason:
                expression: |
                  resources.pullSecretJob.status.conditions[?(@.type=='Failed')].status == "True"
                  ? "JobFailed"
                  : "Healthy"

              message:
                expression: |
                  resources.pullSecretJob.status.conditions[?(@.type=='Failed')].status == "True"
                  ? "Job failed after retries - check pod logs and GCP IAM permissions"
                  : "Adapter is healthy and functioning normally"

          # Additional custom data to report
          data:
            secretName:
              expression: |
                clusterDetails.spec.pullSecret.secretName ?? "hyperfleet-" + clusterId + "-pull-secret"
              description: "GCP Secret Manager secret name"

            secretVersion:
              expression: "latest"
              description: "Secret version (always 'latest' for active version)"

            gcpProject:
              expression: |
                clusterDetails.spec.gcp.projectId
              description: "GCP project ID where secret is stored"

            replicationPolicy:
              expression: |
                clusterDetails.spec.pullSecret.replicationPolicy ?? "automatic"
              description: "Secret replication policy"

            secretPath:
              expression: |
                "projects/" + clusterDetails.spec.gcp.projectId + "/secrets/" +
                (clusterDetails.spec.pullSecret.secretName ?? "hyperfleet-" + clusterId + "-pull-secret") +
                "/versions/latest"
              description: "Full GCP Secret Manager resource path"

    # -------------------------------------------------------------------------
    # Stage 2: Report Status to API
    # -------------------------------------------------------------------------
    postActions:
      # Report status when Job completes or fails
      - type: "api_call"
        method: "POST"
        endpoint: "{{ .hyperfleetApiBaseUrl }}/api/{{ .hyperfleetApiVersion }}/clusters/{{ .clusterId }}/statuses"

        # Only report when Job has reached terminal state
        when:
          expression: |
            pullSecretStatus.conditions.applied.status == "True"
          description: "Report status when Job completes or fails"

        # HTTP headers
        headers:
          - name: "Authorization"
            value: "Bearer {{ .hyperfleetApiToken }}"
          - name: "Content-Type"
            value: "application/json"
          - name: "X-Adapter-Name"
            value: "pullsecret"
          - name: "X-Cluster-Id"
            value: "{{ .clusterId }}"

        # Request body (status payload built above)
        body: |
          {
            "adapterName": "pullsecret",
            "conditions": {{ .pullSecretStatus.conditions | toJson }},
            "data": {{ .pullSecretStatus.data | toJson }}
          }

  # ============================================================================
  # Observability Configuration
  # ============================================================================
  observability:
    # Prometheus metrics endpoint
    metricsPort: 9090

    # Health check endpoints (/healthz, /readyz)
    healthPort: 8080

    # Log level: debug, info, warn, error
    logLevel: "info"

    # Enable OpenTelemetry distributed tracing
    traceEnabled: true

    # Additional custom metrics
    customMetrics:
      - name: "hyperfleet_pullsecret_secrets_created_total"
        type: "counter"
        description: "Total number of secrets created in GCP Secret Manager"
        labels:
          - "cluster_id"
          - "gcp_project"

      - name: "hyperfleet_pullsecret_job_duration_seconds"
        type: "histogram"
        description: "Duration of pull secret Job execution"
        labels:
          - "cluster_id"
          - "result"
        buckets: [1, 5, 10, 30, 60, 120, 300]

      - name: "hyperfleet_pullsecret_gcp_api_calls_total"
        type: "counter"
        description: "Total GCP Secret Manager API calls"
        labels:
          - "method"
          - "status_code"

      - name: "hyperfleet_pullsecret_failures_total"
        type: "counter"
        description: "Total failures categorized by reason"
        labels:
          - "reason"

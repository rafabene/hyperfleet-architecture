asyncapi: 3.0.0
info:
  title: HyperFleet Events
  version: 1.0.0
  description: >
    Cluster Lifecycle Management.
    Defines the commands used to drive the reconciliation loops.
    
components:
  messages:
    ReconcileCluster:
      name: ReconcileCluster
      title: Reconcile Cluster Command
      summary: Instructs the adapters to reconcile the cluster state with the spec.
      contentType: application/json
      payload:
        $ref: '#/components/schemas/ReconcileClusterCloudEvent'
      examples:
        - payload:
            specversion: "1.0"
            type: "com.redhat.hyperfleet.cluster.reconcile.v1"
            source: "/hyperfleet/service/sentinel"
            id: "00000000-0000-0000-0000-000000000000"
            time: "2025-10-23T12:00:00Z"
            datacontenttype: "application/json"
            data:
              id: "11111111-1111-1111-1111-111111111111"
              kind: "Cluster"
              href: "https://api.hyperfleet.com/v1/clusters/11111111-1111-1111-1111-111111111111"
              generation: 5

    ReconcileNodePool:
      name: ReconcileNodePool
      title: Reconcile NodePool Command
      summary: Instructs the adapters to reconcile the NodePool state with the spec.
      contentType: application/json
      payload:
        $ref: '#/components/schemas/ReconcileNodePoolCloudEvent'
      examples:
        - payload:
            specversion: "1.0"
            type: "com.redhat.hyperfleet.nodepool.reconcile.v1"
            source: "/hyperfleet/service/sentinel"
            id: "00000000-0000-0000-0000-000000000000"
            time: "2025-10-23T12:00:00Z"
            datacontenttype: "application/json"
            data:
              id: "22222222-2222-2222-2222-222222222222"
              kind: "NodePool"
              href: "https://api.hyperfleet.com/v1/clusters/11111111-1111-1111-1111-111111111111/nodepools/22222222-2222-2222-2222-222222222222"
              generation: 5
              owned_reference:
                id: "11111111-1111-1111-1111-111111111111"
                kind: "Cluster"
                href: "https://api.hyperfleet.com/v1/clusters/11111111-1111-1111-1111-111111111111"

  schemas:
    # --- Domain Objects ---
    ObjectReference:
      type: object
      required: [id, kind, href]
      properties:
        id:
          type: string
          format: uuid
        kind:
          type: string
          enum:
            - Cluster
            - NodePool
        href:
          type: string
          format: uri

    ReconcileCluster:
      type: object
      required: [generation]
      allOf:
        - $ref: '#/components/schemas/ObjectReference'
      properties:
        kind:
          const: Cluster
        generation:
          type: integer
          minimum: 1
          description: The specific generation of the spec to reconcile to.

    ReconcileNodePool:
      type: object
      required: [generation, owned_reference]
      allOf:
        - $ref: '#/components/schemas/ObjectReference'
      properties:
        kind:
          const: NodePool
        generation:
          type: integer
          minimum: 1
        owned_reference:
          $ref: '#/components/schemas/ObjectReference'

    # --- Envelopes ---
    CloudEvent:
      $ref: 'https://raw.githubusercontent.com/cloudevents/spec/v1.0/spec.json'

    ReconcileClusterCloudEvent:
      type: object
      required:
        - data
      allOf:
        - $ref: '#/components/schemas/CloudEvent'
      properties:
        type:
          const: com.redhat.hyperfleet.cluster.reconcile.v1
        data:
          $ref: '#/components/schemas/ReconcileCluster'
     
    ReconcileNodePoolCloudEvent:
      type: object
      required:
        - data
      allOf:
        - $ref: '#/components/schemas/CloudEvent'
      properties:
        type:
          const: com.redhat.hyperfleet.nodepool.reconcile.v1
        data:
          $ref: '#/components/schemas/ReconcileNodePool'
